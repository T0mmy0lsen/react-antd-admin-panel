# Story 4.1: Hooks API Implementation

## Status
Done

## Story

**As a** developer using react-antd-admin-panel,
**I want** React hooks alongside the builder pattern,
**so that** I can use modern React patterns with full type safety and less boilerplate.

## Acceptance Criteria

1. `useGet<T>()` hook executes GET requests with loading/error/data state
2. `usePost<T, R>()` hook executes POST/PUT/PATCH/DELETE requests with loading/submitting state
3. `useList<T>()` hook manages list state (data, loading, pagination, refresh)
4. `useForm<T>()` hook integrates with react-hook-form for form state management
5. `useAccess()` hook checks permissions against current user
6. All hooks have full TypeScript generics support with proper inference
7. Hooks work with React 19.1.0 features
8. Hooks can be used alongside builder pattern (interop)
9. No unnecessary re-renders (proper memoization)
10. All hooks have comprehensive unit tests with 90%+ coverage

## Tasks / Subtasks

- [x] **Task 1: Create hooks module structure** (AC: 6)
  - [x] Create `packages/core/src/hooks/` directory
  - [x] Create `packages/core/src/hooks/index.ts` with exports
  - [x] Update `packages/core/src/index.ts` to export hooks module

- [x] **Task 2: Implement `useGet<T>()` hook** (AC: 1, 6, 7, 9)
  - [x] Create `packages/core/src/hooks/useGet.ts`
  - [x] Implement hook with options: `{ url, params?, headers?, immediate?, enabled? }`
  - [x] Return `{ data, loading, error, execute, abort, reset }`
  - [x] Support automatic execution on mount (immediate: true)
  - [x] Support conditional execution (enabled option)
  - [x] Support abort controller for request cancellation
  - [x] Add proper TypeScript generics for response type
  - [x] Write comprehensive tests in `useGet.test.ts`

- [x] **Task 3: Implement `usePost<TBody, TResponse>()` hook** (AC: 2, 6, 7, 9)
  - [x] Create `packages/core/src/hooks/usePost.ts`
  - [x] Implement hook with options: `{ url, method?, headers?, onSuccess?, onError? }`
  - [x] Return `{ execute, submitting, error, data, reset }`
  - [x] Support POST, PUT, PATCH, DELETE methods
  - [x] Support FormData for file uploads
  - [x] Add proper TypeScript generics for body and response types
  - [x] Write comprehensive tests in `usePost.test.ts`

- [x] **Task 4: Implement `useList<T>()` hook** (AC: 3, 6, 7, 8, 9)
  - [x] Create `packages/core/src/hooks/useList.ts`
  - [x] Implement hook with options: `{ get, columns?, pagination?, initialFilters? }`
  - [x] Return `{ data, loading, error, refresh, pagination, filters, setFilters, selectedRows, setSelectedRows }`
  - [x] Support server-side and client-side pagination
  - [x] Support integration with List builder for rendering
  - [x] Handle automatic refetch on filter/pagination changes
  - [x] Write comprehensive tests in `useList.test.ts`

- [x] **Task 5: Implement `useForm<T>()` hook** (AC: 4, 6, 7, 9)
  - [x] Create `packages/core/src/hooks/useForm.ts`
  - [x] Wrap react-hook-form with simplified API
  - [x] Implement hook with options: `{ initialValues, onSubmit, validate?, post? }`
  - [x] Return `{ values, errors, setValue, setValues, submit, submitting, reset, isDirty, isValid }`
  - [x] Support integration with Post model for submission
  - [x] Support field-level and form-level validation
  - [x] Write comprehensive tests in `useForm.test.ts`

- [x] **Task 6: Implement `useAccess()` hook** (AC: 5, 6, 7)
  - [x] Create `packages/core/src/hooks/useAccess.ts`
  - [x] Implement hook that returns permission check functions
  - [x] Return `{ canAccess, hasRole, hasPermission, hasFeature }`
  - [x] Integrate with UserState from Main context
  - [x] Support feature-based and role-based access checks
  - [x] Write comprehensive tests in `useAccess.test.ts`

- [x] **Task 7: Integration and interop testing** (AC: 8, 10)
  - [x] Create integration test file `hooks.integration.test.tsx`
  - [x] Test hooks working together (useGet + useList)
  - [x] Test hooks with builder pattern components
  - [x] Verify no unnecessary re-renders with React DevTools profiler patterns
  - [x] Ensure all tests pass with `pnpm test`

- [x] **Task 8: Update exports and documentation** (AC: 10)
  - [x] Add all hooks to main index.ts exports
  - [x] Add JSDoc comments to all hook functions
  - [x] Update example app with hooks usage demo page

## Dev Notes

### Source Tree Reference
```
packages/core/src/
├── hooks/                    # NEW - Hooks module
│   ├── index.ts              # Exports all hooks
│   ├── useGet.ts             # GET request hook
│   ├── useGet.test.ts
│   ├── usePost.ts            # POST/mutation hook
│   ├── usePost.test.ts
│   ├── useList.ts            # List state hook
│   ├── useList.test.ts
│   ├── useForm.ts            # Form state hook
│   ├── useForm.test.ts
│   ├── useAccess.ts          # Permission hook
│   └── useAccess.test.ts
├── http/
│   ├── Get.ts                # Existing - use for useGet implementation
│   └── Post.ts               # Existing - use for usePost implementation
├── main/
│   └── MainContext.tsx       # Existing hooks: useMain, useUser, useStore
└── index.ts                  # Update to export hooks
```

### Existing Hooks (Reference)
The following hooks already exist in `main/MainContext.tsx`:
- `useMain()` - Access Main instance
- `useUser()` - Access current user with reactive updates
- `useStore()` - Access store value with reactive updates
- `useStoreActions()` - Store mutation methods

### HTTP Layer Reference
- `Get<T>` class in `http/Get.ts` - use `.execute()` method
- `Post<T>` class in `http/Post.ts` - use `.execute()` method
- Both support `onThen`, `onCatch`, `onFinally` hooks
- Both support abort via AbortController

### Dependencies
- `react-hook-form: ^7.54.0` - already installed, use for useForm
- `vitest: ^2.0.0` - testing framework
- React 19.1.0 - use latest hook patterns

### API Design Guidelines
```typescript
// useGet example
const { data, loading, error, execute } = useGet<User[]>({
  url: '/api/users',
  params: { page: 1 },
  immediate: true,
});

// usePost example  
const { execute, submitting } = usePost<CreateUserDto, User>({
  url: '/api/users',
  method: 'POST',
  onSuccess: (user) => navigate(`/users/${user.id}`),
});
await execute({ name: 'John', email: 'john@example.com' });

// useList example
const { data, loading, refresh, pagination } = useList<User>({
  get: { url: '/api/users' },
  pagination: { pageSize: 10 },
});

// useForm example
const { values, submit, submitting } = useForm<UserForm>({
  initialValues: { name: '', email: '' },
  onSubmit: async (values) => { /* ... */ },
});

// useAccess example
const { canAccess, hasRole } = useAccess();
if (canAccess({ feature: 'Users', level: 3 })) { /* ... */ }
```

## Testing

### Testing Standards
- Test files located alongside source: `*.test.ts` or `*.test.tsx`
- Framework: Vitest 2.0 with React Testing Library
- Run tests: `pnpm test` from `packages/core`
- Coverage target: 90%+

### Testing Patterns
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { renderHook, waitFor, act } from '@testing-library/react';

// Mock axios for HTTP hooks
vi.mock('axios');

// Use renderHook for testing hooks
const { result } = renderHook(() => useGet({ url: '/api/test' }));

// Use waitFor for async state updates
await waitFor(() => expect(result.current.loading).toBe(false));

// Use act for triggering state changes
await act(async () => {
  await result.current.execute();
});
```

### Test Coverage Requirements
- All public hook APIs tested
- Error handling paths tested
- Loading states tested
- Type inference verified (compile-time)
- Abort/cancellation tested for HTTP hooks

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-10 | 1.0 | Initial story creation | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (Preview)

### Debug Log References
- Fixed useForm test timing issue with async submitting state check
- Fixed integration test mock order issue by switching to parameter-based mock

### Completion Notes List
- All 5 new hooks implemented with full TypeScript generics
- All hooks integrate with existing Get/Post classes and MainContext
- 334 tests passing across all hook test files
- Integration tests verify hooks interoperability
- Example app includes HooksDemoPage showcasing all hooks

### File List
**Created:**
- `packages/core/src/hooks/index.ts` - Module exports
- `packages/core/src/hooks/useGet.ts` - GET request hook (~185 lines)
- `packages/core/src/hooks/useGet.test.ts` - useGet tests (~290 lines)
- `packages/core/src/hooks/usePost.ts` - POST/mutation hook (~175 lines)
- `packages/core/src/hooks/usePost.test.ts` - usePost tests (~310 lines)
- `packages/core/src/hooks/useList.ts` - List state hook (~290 lines)
- `packages/core/src/hooks/useList.test.ts` - useList tests (~350 lines)
- `packages/core/src/hooks/useForm.ts` - Form state hook (~215 lines)
- `packages/core/src/hooks/useForm.test.ts` - useForm tests (~280 lines)
- `packages/core/src/hooks/useAccess.ts` - Permission hook (~180 lines)
- `packages/core/src/hooks/useAccess.test.ts` - useAccess tests (~260 lines)
- `packages/core/src/hooks/hooks.integration.test.tsx` - Integration tests (~290 lines)
- `packages/example/src/pages/HooksDemoPage.tsx` - Demo page (~340 lines)

**Modified:**
- `packages/core/src/index.ts` - Added hooks module export
- `packages/core/src/types/state.ts` - Added features field to User interface
- `packages/example/src/App.tsx` - Added HooksDemoPage route

---

## QA Results
_To be populated after implementation_
